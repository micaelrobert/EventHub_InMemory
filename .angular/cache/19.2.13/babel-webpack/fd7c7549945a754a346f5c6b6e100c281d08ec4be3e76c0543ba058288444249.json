{"ast":null,"code":"import { CommonModule } from \"@angular/common\";\nimport { Validators, ReactiveFormsModule } from \"@angular/forms\";\nimport { MatDialogModule, MAT_DIALOG_DATA } from \"@angular/material/dialog\";\nimport { MatFormFieldModule } from \"@angular/material/form-field\";\nimport { MatInputModule } from \"@angular/material/input\";\nimport { MatButtonModule } from \"@angular/material/button\";\nimport { MatIconModule } from \"@angular/material/icon\";\nimport { MatSelectModule } from \"@angular/material/select\";\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/forms\";\nimport * as i2 from \"../../services/ingressos.service\";\nimport * as i3 from \"../../services/notification.service\";\nimport * as i4 from \"@angular/material/dialog\";\nexport let ComprarIngressoDialogComponent = /*#__PURE__*/(() => {\n  class ComprarIngressoDialogComponent {\n    data;\n    fb;\n    ingressosService;\n    notificationService;\n    dialogRef;\n    evento;\n    compraForm;\n    quantidades = [];\n    valorTotal = 0;\n    comprando = false;\n    constructor(data, fb, ingressosService, notificationService, dialogRef) {\n      this.data = data;\n      this.fb = fb;\n      this.ingressosService = ingressosService;\n      this.notificationService = notificationService;\n      this.dialogRef = dialogRef;\n      this.evento = data.evento;\n      this.gerarQuantidades();\n      this.criarForm();\n    }\n    gerarQuantidades() {\n      // Garante que não haja mais ingressos do que disponíveis e no máximo 10\n      const maxQuantidade = Math.min(this.evento.ingressosDisponiveis || 0, 10);\n      this.quantidades = Array.from({\n        length: maxQuantidade\n      }, (_, i) => i + 1);\n      // Se não houver ingressos disponíveis, ou maxQuantidade for 0, o array estará vazio.\n      // Garante que, se houver ingressos, a quantidade padrão seja 1.\n      if (this.quantidades.length === 0) {\n        this.quantidades = [0]; // Ou você pode lidar com isso no template para desabilitar a compra\n      } else if (this.quantidades.length > 0 && this.compraForm) {\n        this.compraForm.get('quantidade')?.setValue(1); // Define 1 como padrão se houver ingressos\n      }\n    }\n    criarForm() {\n      this.compraForm = this.fb.group({\n        nomeComprador: [\"\", [Validators.required, Validators.minLength(3)]],\n        emailComprador: [\"\", [Validators.required, Validators.email]],\n        telefoneComprador: [\"\", [Validators.required, Validators.pattern(/^\\(\\d{2}\\) \\d{4,5}-\\d{4}$/)]],\n        quantidade: [1, [Validators.required, Validators.min(1)]] // Valor inicial 1\n      });\n      // Se a lista de quantidades for vazia (ex: ingressosDisponiveis = 0), ajusta a quantidade inicial\n      if (this.quantidades.length === 0 || this.quantidades.length === 1 && this.quantidades[0] === 0) {\n        this.compraForm.get('quantidade')?.setValue(0);\n        this.compraForm.get('quantidade')?.disable(); // Desabilita o campo de quantidade\n      }\n      this.calcularTotal();\n    }\n    calcularTotal() {\n      // Adicionei um fallback para caso o evento.precoIngresso seja undefined ou null\n      const preco = this.evento.precoIngresso ?? 0;\n      const quantidade = this.compraForm.get(\"quantidade\")?.value || 0;\n      this.valorTotal = quantidade * preco;\n    }\n    confirmarCompra() {\n      // Se o formulário estiver desabilitado (ex: por não haver ingressos), não prossiga\n      if (this.compraForm.invalid || this.compraForm.disabled) {\n        this.notificationService.error('Por favor, preencha todos os campos corretamente ou verifique a disponibilidade.');\n        return;\n      }\n      this.comprando = true;\n      const compra = {\n        eventoId: this.evento.id,\n        nomeComprador: this.compraForm.value.nomeComprador,\n        emailComprador: this.compraForm.value.emailComprador,\n        telefoneComprador: this.compraForm.value.telefoneComprador,\n        quantidade: this.compraForm.value.quantidade\n      };\n      this.ingressosService.comprarIngresso(compra).subscribe({\n        next: response => {\n          this.comprando = false;\n          if (response.sucesso) {\n            this.notificationService.success('Compra realizada com sucesso!');\n            this.dialogRef.close(true); // Fecha o dialog e indica sucesso\n          } else {\n            this.notificationService.error(response.mensagem || 'Erro ao processar compra');\n          }\n        },\n        error: err => {\n          this.comprando = false;\n          this.notificationService.error('Erro na comunicação com o servidor');\n          console.error(err);\n        }\n      });\n    }\n    cancelar() {\n      this.dialogRef.close(false); // Fecha o dialog e indica cancelamento\n    }\n    formatarTelefone(event) {\n      const input = event.target;\n      let value = input.value.replace(/\\D/g, ''); // Remove tudo que não for dígito\n      if (value.length > 11) value = value.slice(0, 11);\n      if (value.length > 0) {\n        value = value.replace(/^(\\d{2})(\\d)/g, '($1) $2'); // Adiciona parênteses ao DDD\n        value = value.replace(/(\\d{5})(\\d)/, '$1-$2'); // Adiciona hífen ao número\n      }\n      input.value = value;\n      this.compraForm.get('telefoneComprador')?.setValue(value, {\n        emitEvent: false\n      });\n    }\n    static ɵfac = function ComprarIngressoDialogComponent_Factory(__ngFactoryType__) {\n      return new (__ngFactoryType__ || ComprarIngressoDialogComponent)(i0.ɵɵdirectiveInject(MAT_DIALOG_DATA), i0.ɵɵdirectiveInject(i1.FormBuilder), i0.ɵɵdirectiveInject(i2.IngressosService), i0.ɵɵdirectiveInject(i3.NotificationService), i0.ɵɵdirectiveInject(i4.MatDialogRef));\n    };\n    static ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n      type: ComprarIngressoDialogComponent,\n      selectors: [[\"app-comprar-ingresso-dialog\"]],\n      decls: 0,\n      vars: 0,\n      template: function ComprarIngressoDialogComponent_Template(rf, ctx) {},\n      dependencies: [CommonModule, ReactiveFormsModule, MatDialogModule, MatFormFieldModule, MatInputModule, MatButtonModule, MatIconModule, MatSelectModule],\n      encapsulation: 2\n    });\n  }\n  return ComprarIngressoDialogComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}